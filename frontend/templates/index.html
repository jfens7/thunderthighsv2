<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thunder Thighs V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        #suggestions-list, #compare-suggestions-list {
            position: absolute;
            background-color: #1e293b;
            border: 1px solid #334155;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            border-radius: 0 0 8px 8px;
            display: none;
        }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #334155; }
        .suggestion-item:hover { background-color: #334155; }

        .match-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #334155; }
        .match-row:last-child { border-bottom: none; }
        .win-text { color: #4ade80; font-weight: bold; }
        .loss-text { color: #f87171; font-weight: bold; }
        
        .filter-btn { padding: 8px 16px; border-radius: 99px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; border: 1px solid #334155; color: #94a3b8; }
        .filter-btn:hover { background-color: #334155; color: white; }
        .filter-btn.active { background-color: #f97316; border-color: #f97316; color: white; }
        .modal-bg { background-color: rgba(0,0,0,0.85); }
        
        /* Date Input Styling */
        input[type="date"] {
            color-scheme: dark;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-6 relative">

    <h1 class="text-4xl font-bold text-orange-500 mb-2">THUNDER THIGHS V2</h1>
    <p class="text-gray-400 mb-8">Career Tracker</p>

    <div class="w-full max-w-xl relative mb-8">
        <div class="relative">
            <input type="text" id="playerSearch" 
                   class="w-full p-4 pl-12 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:border-orange-500 text-lg shadow-lg" 
                   placeholder="Search player..." autocomplete="off">
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-5 text-gray-500"></i>
        </div>
        <div id="suggestions-list"></div>
    </div>

    <div id="statsContainer" class="w-full max-w-4xl hidden mb-20"> 
        
        <h2 id="playerName" class="text-3xl font-bold text-center mb-2 text-white"></h2>
        
        <div class="flex justify-center gap-2 mb-6">
            <button onclick="switchMode('regular')" id="btn-regular" class="filter-btn active">Regular</button>
            <button onclick="switchMode('combined')" id="btn-combined" class="filter-btn">Combined</button>
            <button onclick="switchMode('fillin')" id="btn-fillin" class="filter-btn">Fill-in Only</button>
        </div>

        <div class="flex flex-wrap justify-center items-center gap-3 mb-8 bg-slate-800 p-4 rounded-xl border border-slate-700">
            <select id="seasonSelect" class="bg-slate-900 border border-slate-600 p-2 rounded text-white text-sm min-w-[120px]"></select>
            
            <select id="divisionSelect" class="bg-slate-900 border border-slate-600 p-2 rounded text-white text-sm min-w-[120px]">
                <option value="All">All Divisions</option>
            </select>
            
            <div class="h-8 w-px bg-slate-600 mx-2 hidden sm:block"></div>

            <div class="flex items-center gap-2">
                <input type="date" id="startDate" class="bg-slate-900 border border-slate-600 p-2 rounded text-white text-sm" placeholder="Start">
                <span class="text-gray-500">-</span>
                <input type="date" id="endDate" class="bg-slate-900 border border-slate-600 p-2 rounded text-white text-sm" placeholder="End">
            </div>

            <div class="h-8 w-px bg-slate-600 mx-2 hidden sm:block"></div>
            
            <button onclick="openCompareModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded border border-slate-600 text-sm">
                <i class="fa-solid fa-scale-balanced mr-1"></i> Compare
            </button>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="card">
                <div id="matchesPlayed" class="text-4xl font-bold text-blue-400">0</div>
                <div class="text-sm text-gray-400 mt-1">MATCHES</div>
            </div>
            <div class="card">
                <div id="wins" class="text-4xl font-bold text-green-400">0</div>
                <div class="text-sm text-gray-400 mt-1">WINS</div>
            </div>
            <div class="card">
                <div id="losses" class="text-4xl font-bold text-red-400">0</div>
                <div class="text-sm text-gray-400 mt-1">LOSSES</div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="card">
                <div id="winRate" class="text-4xl font-bold text-orange-400">0%</div>
                <div class="text-sm text-gray-400 mt-1">WIN %</div>
            </div>
            <div class="card bg-slate-800 border border-slate-700">
                <div id="setsWon" class="text-4xl font-bold text-purple-400">0</div>
                <div class="text-sm text-gray-400 mt-1">SETS WON</div>
            </div>
            <div class="card bg-slate-800 border border-slate-700">
                <div id="setsLost" class="text-4xl font-bold text-pink-400">0</div>
                <div class="text-sm text-gray-400 mt-1">SETS LOST</div>
            </div>
        </div>

        <div class="w-full">
            <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-600 pb-2">Match History</h3>
            <div id="matchHistory" class="bg-slate-800 rounded-lg shadow-lg mb-4"></div>
            <button id="seeAllBtn" onclick="toggleHistory()" class="w-full py-3 text-center text-slate-400 hover:text-white bg-slate-800 rounded-lg border border-slate-700 hidden">
                View All Matches <i class="fa-solid fa-chevron-down ml-1"></i>
            </button>
        </div>

    </div>

    <div class="mt-auto py-6 text-center border-t border-slate-800 w-full">
        <button onclick="openReportModal()" class="text-sm text-slate-500 hover:text-orange-500 underline flex items-center justify-center gap-2 mx-auto">
            <i class="fa-solid fa-flag"></i> Report Incorrect Result
        </button>
        <div class="text-xs text-slate-700 mt-2">Thunder Thighs V2 â€¢ Built for GCTTA</div>
    </div>

    <div id="compareModal" class="fixed inset-0 flex items-center justify-center hidden z-50 modal-bg">
        <div class="bg-slate-900 rounded-xl p-6 w-full max-w-md border border-slate-700 shadow-2xl relative">
            <button onclick="closeCompareModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-white mb-4">Head-to-Head</h3>
            <div class="relative mb-6">
                <input type="text" id="compareInput" class="w-full p-3 rounded bg-slate-800 border border-slate-700 text-white focus:border-orange-500 focus:outline-none" placeholder="Enter opponent name..." autocomplete="off">
                <div id="compare-suggestions-list"></div>
            </div>
            <div id="compareResults" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <div class="text-center w-1/3">
                        <div class="text-orange-500 font-bold text-lg truncate" id="comp-p1-name">P1</div>
                        <div class="text-4xl font-bold text-white" id="comp-p1-wins">0</div>
                        <div class="text-xs text-gray-400">WINS</div>
                    </div>
                    <div class="text-gray-500 font-bold">VS</div>
                    <div class="text-center w-1/3">
                        <div class="text-blue-500 font-bold text-lg truncate" id="comp-p2-name">P2</div>
                        <div class="text-4xl font-bold text-white" id="comp-p2-wins">0</div>
                        <div class="text-xs text-gray-400">WINS</div>
                    </div>
                </div>
                <h4 class="text-gray-400 text-sm mb-2 border-b border-gray-700 pb-1">Match Log</h4>
                <div id="compareLog" class="max-h-40 overflow-y-auto text-sm"></div>
            </div>
        </div>
    </div>

    <div id="reportModal" class="fixed inset-0 flex items-center justify-center hidden z-50 modal-bg">
        <div class="bg-slate-900 rounded-xl p-6 w-full max-w-lg border border-slate-700 shadow-2xl relative">
            <button onclick="closeReportModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-white mb-4 text-orange-500">Report Issue</h3>
            
            <label class="block text-gray-400 text-sm mb-1">Your Name (Optional)</label>
            <input id="repName" type="text" class="w-full p-2 mb-3 rounded bg-slate-800 border border-slate-700 text-white" placeholder="e.g. John Smith">
            
            <label class="block text-gray-400 text-sm mb-1">Season / Match</label>
            <input id="repMatch" type="text" class="w-full p-2 mb-3 rounded bg-slate-800 border border-slate-700 text-white" placeholder="e.g. Spring 2025 - Me vs Steve">
            
            <label class="block text-gray-400 text-sm mb-1">Description of Error</label>
            <textarea id="repDesc" class="w-full p-2 mb-4 rounded bg-slate-800 border border-slate-700 text-white h-24" placeholder="e.g. The score was actually 3-2, not 3-0..."></textarea>
            
            <button onclick="submitReport()" class="w-full py-2 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded">Submit Report</button>
        </div>
    </div>

    <script>
        let allPlayers = [], currentSeason = "Career", currentDivision = "All", currentPlayerStats = null, currentMode = "regular", historyExpanded = false;
        let startDate = "", endDate = "";

        window.onload = async () => {
            const pRes = await fetch('/api/players'); allPlayers = await pRes.json();
            const sRes = await fetch('/api/seasons'); const seasons = await sRes.json();
            const seasonSelect = document.getElementById('seasonSelect');
            seasons.forEach(s => { let opt = document.createElement('option'); opt.value = s; opt.innerText = s; seasonSelect.appendChild(opt); });

            const dRes = await fetch('/api/divisions'); const divisions = await dRes.json();
            const divisionSelect = document.getElementById('divisionSelect');
            divisions.forEach(d => { let opt = document.createElement('option'); opt.value = d; opt.innerText = d; divisionSelect.appendChild(opt); });

            // Event Listeners
            seasonSelect.addEventListener('change', (e) => { currentSeason = e.target.value; reloadStats(); });
            divisionSelect.addEventListener('change', (e) => { currentDivision = e.target.value; reloadStats(); });
            document.getElementById('startDate').addEventListener('change', (e) => { startDate = e.target.value; reloadStats(); });
            document.getElementById('endDate').addEventListener('change', (e) => { endDate = e.target.value; reloadStats(); });
        };

        function reloadStats() { const name = document.getElementById('playerName').innerText; if(name) loadStats(name); }
        setupSearch('playerSearch', 'suggestions-list', (name) => loadStats(name));
        setupSearch('compareInput', 'compare-suggestions-list', (name) => loadComparison(name));

        function setupSearch(inputId, listId, callback) {
            const input = document.getElementById(inputId); const list = document.getElementById(listId);
            input.addEventListener('input', () => {
                const val = input.value.toLowerCase(); list.innerHTML = '';
                if (!val) { list.style.display = 'none'; return; }
                const filtered = allPlayers.filter(p => p.toLowerCase().includes(val)).slice(0, 10);
                filtered.forEach(player => {
                    const div = document.createElement('div'); div.className = 'suggestion-item'; div.innerText = player;
                    div.onclick = () => { input.value = player; list.style.display = 'none'; callback(player); };
                    list.appendChild(div);
                });
                list.style.display = filtered.length ? 'block' : 'none';
            });
        }

        async function loadStats(player) {
            document.getElementById('statsContainer').classList.remove('hidden'); 
            document.getElementById('playerName').innerText = player; 
            document.getElementById('playerSearch').value = player;
            historyExpanded = false; 
            try {
                // Pass Date filters
                let url = `/api/stats/${encodeURIComponent(player)}?season=${encodeURIComponent(currentSeason)}&division=${encodeURIComponent(currentDivision)}`;
                if(startDate) url += `&start=${startDate}`;
                if(endDate) url += `&end=${endDate}`;
                
                const res = await fetch(url);
                const data = await res.json();
                if (data.error) { alert("Player not found."); return; }
                currentPlayerStats = data; renderStats();
            } catch (err) { console.error("Error:", err); }
        }

        function switchMode(mode) {
            currentMode = mode; document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active'); if (currentPlayerStats) renderStats();
        }

        function renderStats() {
            const stats = currentPlayerStats[currentMode];
            animateValue("matchesPlayed", stats.matches); animateValue("wins", stats.wins); animateValue("losses", stats.losses);
            document.getElementById("winRate").innerText = stats.win_rate; animateValue("setsWon", stats.sets_won); animateValue("setsLost", stats.sets_lost);
            renderHistory(stats.match_history);
        }

        function renderHistory(matches) {
            const historyDiv = document.getElementById('matchHistory'); const seeAllBtn = document.getElementById('seeAllBtn'); historyDiv.innerHTML = ""; 
            if (!matches || matches.length === 0) { historyDiv.innerHTML = '<div class="p-4 text-center text-gray-500">No matches found.</div>'; seeAllBtn.classList.add('hidden'); return; }
            const limit = historyExpanded ? matches.length : 5; matches.slice(0, limit).forEach(match => {
                const row = document.createElement('div'); row.className = "match-row";
                const resultClass = match.result === "Win" ? "win-text" : "loss-text"; const resultIcon = match.result === "Win" ? "W" : "L";
                let tag = (currentMode === "combined" && match.type === "Fill-in") ? `<span class="text-xs bg-slate-600 px-2 py-0.5 rounded ml-2 text-gray-300">Fill-in</span>` : "";
                let divTag = (currentDivision === "All" && match.division) ? `<span class="text-xs text-slate-500 ml-2 border border-slate-700 px-1 rounded">${match.division}</span>` : "";
                let dateHtml = match.date ? `<span class="text-xs text-slate-500 mr-2">${match.date}</span>` : "";
                const safeOpponent = match.opponent.replace(/'/g, "\\'");

                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="${resultClass} text-lg w-6">${resultIcon}</span>
                        <div class="flex items-center">
                            <span class="text-gray-300 mr-1">vs</span>
                            <a href="#" onclick="loadStats('${safeOpponent}'); return false;" class="text-white hover:text-orange-400 hover:underline transition-colors">${match.opponent}</a>
                            ${tag}
                        </div>
                    </div>
                    <div class="flex items-center">${dateHtml}${divTag}<span class="font-mono text-gray-400 ml-2">${match.score}</span></div>`;
                historyDiv.appendChild(row);
            });
            seeAllBtn.classList.toggle('hidden', matches.length <= 5);
            seeAllBtn.innerHTML = historyExpanded ? 'Show Less <i class="fa-solid fa-chevron-up ml-1"></i>' : 'View All Matches <i class="fa-solid fa-chevron-down ml-1"></i>';
        }

        function toggleHistory() { historyExpanded = !historyExpanded; renderStats(); }
        function animateValue(id, end) { document.getElementById(id).innerHTML = end; }
        
        // --- MODALS ---
        function openCompareModal() { document.getElementById('compareModal').classList.remove('hidden'); document.getElementById('compareResults').classList.add('hidden'); document.getElementById('compareInput').value = ''; }
        function closeCompareModal() { document.getElementById('compareModal').classList.add('hidden'); }
        async function loadComparison(opponent) {
            const p1 = document.getElementById('playerName').innerText;
            const res = await fetch(`/api/compare/${encodeURIComponent(p1)}/${encodeURIComponent(opponent)}`); const data = await res.json();
            document.getElementById('compareResults').classList.remove('hidden'); document.getElementById('comp-p1-name').innerText = data.player1; document.getElementById('comp-p2-name').innerText = data.player2; document.getElementById('comp-p1-wins').innerText = data.p1_wins; document.getElementById('comp-p2-wins').innerText = data.p2_wins;
            const logDiv = document.getElementById('compareLog'); logDiv.innerHTML = '';
            data.matches.forEach(m => { const color = m.result === "Win" ? "text-green-400" : "text-red-400"; logDiv.innerHTML += `<div class="flex justify-between py-1 border-b border-slate-700"><span class="${color} font-bold">${m.result}</span> <span>${m.score}</span></div>`; });
        }

        // --- REPORTING ---
        function openReportModal() { document.getElementById('reportModal').classList.remove('hidden'); }
        function closeReportModal() { document.getElementById('reportModal').classList.add('hidden'); }
        async function submitReport() {
            const btn = document.querySelector('#reportModal button'); const originalText = btn.innerText; btn.innerText = "Sending..."; btn.disabled = true;
            const payload = {
                reporter: document.getElementById('repName').value,
                season: currentSeason,
                match_info: document.getElementById('repMatch').value,
                description: document.getElementById('repDesc').value
            };
            try {
                const res = await fetch('/api/report', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if (res.ok) { alert("Report sent! We will review it shortly."); closeReportModal(); document.getElementById('repDesc').value = ""; }
                else alert("Error submitting report.");
            } catch (e) { alert("Network error."); }
            btn.innerText = originalText; btn.disabled = false;
        }
    </script>
</body>
</html>